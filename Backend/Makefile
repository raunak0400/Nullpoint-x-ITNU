# Air Quality Forecasting API - Production Makefile

.PHONY: help install dev test build deploy clean logs status

# Default target
help:
	@echo "ğŸŒ¬ï¸  Air Quality Forecasting API - Production Commands"
	@echo ""
	@echo "ğŸ“¦ Setup Commands:"
	@echo "  make install     - Install dependencies"
	@echo "  make setup       - Setup environment and database"
	@echo ""
	@echo "ğŸš€ Development Commands:"
	@echo "  make dev         - Run development server"
	@echo "  make test        - Run tests"
	@echo "  make lint        - Run code linting"
	@echo ""
	@echo "ğŸ—ï¸  Production Commands:"
	@echo "  make build       - Build Docker images"
	@echo "  make deploy      - Deploy to production"
	@echo "  make deploy-dev  - Deploy to development"
	@echo ""
	@echo "ğŸ”§ Management Commands:"
	@echo "  make logs        - View application logs"
	@echo "  make status      - Check service status"
	@echo "  make clean       - Clean up containers and images"
	@echo "  make backup      - Backup database"
	@echo "  make restore     - Restore database"

# Setup and Installation
install:
	@echo "ğŸ“¦ Installing dependencies..."
	pip install -r requirements.txt

setup:
	@echo "ğŸ”§ Setting up environment..."
	@if [ ! -f .env ]; then cp .env.example .env; echo "ğŸ“ Created .env file from template"; fi
	@echo "âœ… Environment setup complete"
	@echo "ğŸ“ Please edit .env file with your configuration"

# Development
dev:
	@echo "ğŸš€ Starting development server..."
	python run.py

test:
	@echo "ğŸ§ª Running tests..."
	python -m pytest tests/ -v --cov=app --cov-report=html

lint:
	@echo "ğŸ” Running code linting..."
	flake8 app/ --max-line-length=100
	black app/ --check
	isort app/ --check-only

format:
	@echo "ğŸ¨ Formatting code..."
	black app/
	isort app/

# Production Deployment
build:
	@echo "ğŸ—ï¸  Building Docker images..."
	docker-compose build --no-cache

deploy:
	@echo "ğŸš€ Deploying to production..."
	chmod +x deploy.sh
	./deploy.sh production

deploy-dev:
	@echo "ğŸš€ Deploying to development..."
	chmod +x deploy.sh
	./deploy.sh development

# Management
logs:
	@echo "ğŸ“‹ Viewing application logs..."
	docker-compose logs -f app

logs-all:
	@echo "ğŸ“‹ Viewing all service logs..."
	docker-compose logs -f

status:
	@echo "ğŸ“Š Checking service status..."
	docker-compose ps
	@echo ""
	@echo "ğŸ¥ Health checks:"
	@curl -s http://localhost:5000/health | jq . || echo "âŒ API not responding"

clean:
	@echo "ğŸ§¹ Cleaning up containers and images..."
	docker-compose down -v
	docker system prune -f
	docker volume prune -f

# Database Management
backup:
	@echo "ğŸ’¾ Creating database backup..."
	@mkdir -p backups
	docker-compose exec mongodb mongodump --db airquality_prod --out /tmp/backup
	docker cp $$(docker-compose ps -q mongodb):/tmp/backup ./backups/backup_$$(date +%Y%m%d_%H%M%S)
	@echo "âœ… Backup created in backups/ directory"

restore:
	@echo "ğŸ”„ Restoring database..."
	@if [ -z "$(BACKUP_PATH)" ]; then echo "âŒ Please specify BACKUP_PATH=path/to/backup"; exit 1; fi
	docker cp $(BACKUP_PATH) $$(docker-compose ps -q mongodb):/tmp/restore
	docker-compose exec mongodb mongorestore --db airquality_prod /tmp/restore
	@echo "âœ… Database restored"

# Monitoring
monitor:
	@echo "ğŸ“ˆ Opening monitoring dashboard..."
	@echo "Prometheus: http://localhost:9090"
	@echo "API Health: http://localhost:5000/health"
	@echo "Admin Panel: http://localhost:5000/api/admin/stats"

# Security
security-scan:
	@echo "ğŸ”’ Running security scan..."
	docker run --rm -v $(PWD):/app securecodewarrior/docker-security-scanner /app

# Performance Testing
load-test:
	@echo "âš¡ Running load tests..."
	@if command -v ab > /dev/null; then \
		ab -n 1000 -c 10 http://localhost:5000/health; \
	else \
		echo "âŒ Apache Bench (ab) not installed. Install with: apt-get install apache2-utils"; \
	fi

# API Documentation
docs:
	@echo "ğŸ“š Generating API documentation..."
	@echo "API endpoints available at:"
	@echo "  GET  /health                     - Health check"
	@echo "  GET  /api/forecast/              - ML-based forecasting"
	@echo "  GET  /api/forecast/merged        - Merged data from all sources"
	@echo "  GET  /api/forecast/performance   - Model performance metrics"
	@echo "  GET  /api/admin/scheduler/status - Scheduler status"
	@echo "  POST /api/admin/scheduler/start  - Start scheduler"
	@echo "  GET  /api/admin/stats            - System statistics"

# Environment Management
env-prod:
	@echo "ğŸ­ Switching to production environment..."
	@cp .env.production .env 2>/dev/null || echo "âŒ .env.production not found"

env-dev:
	@echo "ğŸ”§ Switching to development environment..."
	@cp .env.development .env 2>/dev/null || cp .env.example .env

# Quick Start
quick-start: setup install build deploy
	@echo "ğŸ‰ Quick start completed!"
	@echo "ğŸŒ API available at: http://localhost:5000"
